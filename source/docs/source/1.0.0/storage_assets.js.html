<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>storage/assets.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="initListeners.html">initListeners</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Journals.html">Journals</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#label">label</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#newlabel">newlabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#push">push</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#removelabel">removelabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#save">save</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Label.html">Label</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="newEditor.html">newEditor</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html">NotSoSimpleAudio</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#_acceptTuneView">_acceptTuneView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#_make">_make</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#_toggleTune">_toggleTune</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#onDropHandler">onDropHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#onPaste">onPaste</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#render">render</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#renderSettings">renderSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#save">save</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="NotSoSimpleImage.html">NotSoSimpleImage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#_acceptTuneView">_acceptTuneView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#_make">_make</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#_toggleTune">_toggleTune</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#onDropHandler">onDropHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#onPaste">onPaste</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#render">render</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#renderSettings">renderSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#save">save</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="timer.html">timer</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createTimerText">createTimerText</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#deleteTimerText">deleteTimerText</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#initWebcam">initWebcam</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#populateCameraChoices">populateCameraChoices</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showWebcam">showWebcam</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toggleScene">toggleScene</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateDates">updateDates</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">storage/assets.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Dexie = require("dexie");
const Md5 = require("md5");

class Assets {
  constructor(db) {
    this.db = db;
    this.map = {};
  }

  /**
   * Retrieve an asset from database
   * @param {String} uid asset unique id
   * @return {Promise&lt;Blob>} promise object resolving to a blob object
   */
  get(uid) {
    if (this.map.uid) {
      console.log("[Assets] getting asset from cache: " + uid);
      return new Promise(resolve => resolve(this.map[uid]));
    }

    console.log("[Assets] getting asset: " + uid);
    return this.db.retrieve(uid).then(obj => {
      return fetch(obj.data);
    }).then(response => {
      return response.blob().then(blob => {
        this.map[uid] = blob;
        return blob;
      });
    });
  }

  /**
   * Saving an blob object to database
   * @param {Blob} blob blob object
   * @returns {Promise&lt;String>} promise object resolving to the key of that object
   */
  save(blob) {
    console.log("[Assets] saving asset");
    const reader = new FileReader();

    reader.readAsDataURL(blob);

    return new Promise(resolve => {
      reader.onload = (event) => {
        resolve(this.db.submit({uid: Md5(event.target.result), type: blob.type, data: event.target.result}));
      }
    }).then(uid => {
      console.log("[Assets] saved: " + uid)
      this.map[uid] = blob;
      return uid;
    });
  }

  del(uid) {
    this.db.remove(uid);
    if (this.map.uid) delete this.map[uid];
    return 0;
  }
}

class AssetsDexieWrapper {
  constructor(table) {
    this.db = new Dexie(table);
    this.db.version(1).stores({
      assets: 'uid,type',
    });
  }

  retrieve(uid) {
    return this.db.assets.get(uid);
  }

  submit(data) {
    return this.db.assets.put(data).then(obj => {
      console.log("[Assets] submited. uid is", obj);
      return Promise.resolve(obj);
    })
  }

  remove(uid) {
    return this.db.assets.delete(uid);
  }
}

class AssetsMockWrapper {
  constructor() {
    this.db = {};
  }

  retrieve(uid) {
    return Promise.resolve({data:this.db[uid]});
  }

  submit(data) {
    this.db[data.uid] = data
    return Promise.resolve(data.uid);
  }

  remove(uid) {
    delete this.db[uid];
    return Promise.resolve(uid);
  }
}

module.exports = {
    Assets: Assets,
    AssetsDexieWrapper: AssetsDexieWrapper,
    AssetsMockWrapper: AssetsMockWrapper
}

exports.Assets = Assets;
exports.AssetsDexieWrapper = AssetsDexieWrapper;
exports.AssetsMockWrapper = AssetsMockWrapper;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Thu Jun 10 2021 05:17:10 GMT+0530 (India Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
