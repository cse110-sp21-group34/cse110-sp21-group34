<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>utils/webcam.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="initListeners.html">initListeners</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Journals.html">Journals</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#label">label</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#newlabel">newlabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#push">push</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#removelabel">removelabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#save">save</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Label.html">Label</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="newEditor.html">newEditor</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html">NotSoSimpleAudio</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#_acceptTuneView">_acceptTuneView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#_make">_make</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#_toggleTune">_toggleTune</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#onDropHandler">onDropHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#onPaste">onPaste</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#render">render</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#renderSettings">renderSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#save">save</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="NotSoSimpleImage.html">NotSoSimpleImage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#_acceptTuneView">_acceptTuneView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#_make">_make</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#_toggleTune">_toggleTune</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#onDropHandler">onDropHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#onPaste">onPaste</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#render">render</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#renderSettings">renderSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#save">save</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="timer.html">timer</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createButton">createButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createLabel">createLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createNew">createNew</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createRecorder">createRecorder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createTimerText">createTimerText</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#deleteTimerText">deleteTimerText</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#editLabel">editLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#initWebcam">initWebcam</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#populateCameraChoices">populateCameraChoices</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showWebcam">showWebcam</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toggleScene">toggleScene</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateDates">updateDates</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateMonthLanguage">updateMonthLanguage</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">utils/webcam.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import styles from './css/webcamStyle.css';

const storage = require('storage');
let imageSource = document.createElement("video");
imageSource.setAttribute("autoplay", true);;

/**  
 * Shows the webcam feature.
*/
function showWebcam(){
  // Camera holder
  let cameraContainer = document.createElement("div");
  cameraContainer.id = "camera-container";

  // Control Bar
  let recordingControls = document.createElement("div");
  recordingControls.id = "recording-controls";

  // Capture piture button
  let pictureBtn = document.createElement("button");
  pictureBtn.id = "picture";
  pictureBtn.setAttribute('disabled', true);
  let cameraIcon = document.createElement("i");
  cameraIcon.className = "bi bi-camera-fill";
  cameraIcon.id = "cameraIcon";
  recordingControls.appendChild(pictureBtn);
  pictureBtn.appendChild(cameraIcon);

  // Camera feature button
  let cameraOptionBtn = document.createElement("button");
  cameraOptionBtn.id = "cameraOption";
  cameraOptionBtn.setAttribute('disabled', true);
  let cameraOptionIcon = document.createElement("i");
  cameraOptionIcon.className = "bi bi-arrow-repeat";
  cameraOptionIcon.id = "cameraOptionIcon";
  recordingControls.appendChild(cameraOptionBtn);
  cameraOptionBtn.appendChild(cameraOptionIcon);

  // Preview Overlay
  let videoSnapshot = document.createElement("div");
  videoSnapshot.id = "video-snapshot-overlay";

  let video = document.createElement("video");
  video.id = "video-element";
  video.setAttribute("autoplay", "true");
  video.setAttribute("width", "480");
  video.setAttribute("height", "360");
  
  // Construct the webcam HTML elements.
  cameraContainer.appendChild(videoSnapshot);
  cameraContainer.appendChild(video);
  cameraContainer.appendChild(recordingControls);
  
  // Appending the webcam.
  document.getElementById('editor').appendChild(cameraContainer);
}

/**
 * Controls the environment when the webcam feature is enabled. Acts as
 * as a routing mechanism to control other HTML elements.
 * 
 * @param {string} scene - Represents the case oh which it falls into.
 * @param {HTMLElement&lt;canvas>} canvas - To draw the captured image.
 */
function toggleScene(scene, canvas) {
  const recordingControls = document.getElementById('recording-controls'),
        captureBtn = document.getElementById('picture'),
        cameraOptionBtn = document.getElementById('cameraOption');
  let pictureAcceptBtn = document.getElementById('pictureAccept'),
      pictureDeclineBtn = document.getElementById('pictureDecline');

  switch (scene) {
    case 'live':
      if (pictureAcceptBtn) pictureAcceptBtn.remove();
      if (pictureDeclineBtn) pictureDeclineBtn.remove();
      captureBtn.removeAttribute('hidden');
      cameraOptionBtn.removeAttribute('hidden');
      document.getElementById('camera_preview_img').remove();
      break;
    case 'preview':
      cameraOptionBtn.setAttribute('hidden', true);

      // Creates the accept button in the preview.
      pictureAcceptBtn = document.createElement("button");
      pictureAcceptBtn.id = "pictureAccept";
      let pictureAcceptIcon = document.createElement("i");
      pictureAcceptIcon.className = "bi bi-check2";
      pictureAcceptIcon.id = "pictureAcceptIcon";
      recordingControls.appendChild(pictureAcceptBtn);
      pictureAcceptBtn.appendChild(pictureAcceptIcon);
    
      // Creates the decline in the preview.
      pictureDeclineBtn = document.createElement("button");
      pictureDeclineBtn.id = "pictureDecline";
      let pictureDeclineIcon = document.createElement("i");
      pictureDeclineIcon.className = "bi bi-x";
      pictureDeclineIcon.id = "pictureDeclineIcon";
      recordingControls.appendChild(pictureDeclineBtn);
      pictureDeclineBtn.appendChild(pictureDeclineIcon);

      pictureAcceptBtn.addEventListener('click', () => {
        // transport to editor
        canvas.toBlob(blob => 
          storage.assets.save(blob).then(uid => storage.currentEditor.blocks.insert("image", {asset_id: uid}, {}, storage.currentEditor.blocks.getBlocksCount()))
        );
        toggleScene('live');
      });

      pictureDeclineBtn.addEventListener('click', () => {
        toggleScene('live');
      });
      break;
  }
}

let cameraChoices = [];

/**
 * Collect and populate all available webcams.
 * 
 * @return {EventTarget} - Returns all available camera devices.
 */
function populateCameraChoices() {
  let videoElem = document.getElementById("video-element");
  cameraChoices = [];
  navigator.mediaDevices.enumerateDevices().then(mediaDevices => {
    mediaDevices.forEach(mediaDevice => {
      if (mediaDevice.kind === 'videoinput') {
        cameraChoices.push(mediaDevice);
      }
    });
  
    if (cameraChoices.length == 0) {
      console.error('No webcam found!');
      return;
    }

    // Default camera will run
    const cameraOptionBtn = document.getElementById('cameraOption'),
          pictureBtn = document.getElementById('picture');

    const constraints = {
      video: {
        deviceId: cameraChoices[0].deviceId
      }
    };

    console.log(cameraChoices);

    navigator.mediaDevices
      .getUserMedia(constraints)
      .then(stream => {
        let streamSettings = stream.getVideoTracks()[0].getSettings();
        imageSource.setAttribute('width', streamSettings.width);
        imageSource.setAttribute('height', streamSettings.height);
        imageSource.srcObject = stream;
        videoElem.srcObject = stream;
        return navigator.mediaDevices.enumerateDevices();
    })

    cameraOptionBtn.setAttribute('camid', 0);
    cameraOptionBtn.setAttribute('cam_name', cameraChoices[0].label);

    cameraOptionBtn.addEventListener('click', () => {
      let nextCamid = 1 + +cameraOptionBtn.getAttribute('camid');
      if (nextCamid >= cameraChoices.length) {
        nextCamid = 0;
      }
      const constraints = {
        video: {
          deviceId: cameraChoices[nextCamid].deviceId
        }
      };

      navigator.mediaDevices
        .getUserMedia(constraints)
        .then(stream => {
          // Stop the original camera before switching
          videoElem.srcObject.getTracks().forEach(track => track.stop());
          let streamSettings = stream.getVideoTracks()[0].getSettings();
          imageSource.setAttribute('width', streamSettings.width);
          imageSource.setAttribute('height', streamSettings.height);
          imageSource.srcObject = stream;
          videoElem.srcObject = stream;
          return navigator.mediaDevices.enumerateDevices();
        });

      cameraOptionBtn.setAttribute('camid', nextCamid);
      cameraOptionBtn.setAttribute('cam_name', cameraChoices[nextCamid].label);
    });

    cameraOptionBtn.removeAttribute('disabled');
    pictureBtn.removeAttribute('disabled');
  });
}

let cameraActivated = false;

/**
 * Initialize webcam in the editor.
 */
function initWebcam(editor) {

  // Show the webcam feature after the button has been clicked.
  document.getElementsByClassName("bi bi-plus-circle")[0].addEventListener("click", ()=> {
    if(cameraActivated == true) {
      let videoElem = document.getElementById("video-element");
      let photosContainer = document.getElementById('photos-container');
      let cameraContainer = document.getElementById('camera-container');
      videoElem.srcObject.getTracks().forEach(track => track.stop());
      videoElem.srcObject = null;
      imageSource.srcObject = null;
      document.getElementById('editor').removeChild(cameraContainer);
      cameraActivated = false;
      document.getElementById("additionMicrophone").style.opacity = "100";
      document.getElementById("additionMicrophone").style.pointerEvents = "all";
    }
  })

  document.getElementById("additionCamera").addEventListener("click", () => {
    if(cameraActivated == true) {
      let videoElem = document.getElementById("video-element");
      let cameraContainer = document.getElementById('camera-container');
      videoElem.srcObject.getTracks().forEach(track => track.stop());
      videoElem.srcObject = null;
      imageSource.srcObject = null;
      document.getElementById('editor').removeChild(cameraContainer);
      cameraActivated = false;
      document.getElementById("additionMicrophone").style.opacity = "100";
      document.getElementById("additionMicrophone").style.pointerEvents = "all";
    }
    else {
      cameraActivated = true;
      showWebcam(); 

      document.getElementById("additionMicrophone").style.opacity = "0";
      document.getElementById("additionMicrophone").style.pointerEvents = "none";

      let pictureBtn = document.getElementById("picture");
      let videoElem = document.getElementById("video-element");
      let videoOverlay = document.getElementById('video-snapshot-overlay');

      // When the picture button is clicked, capture a frame from the video
      pictureBtn.addEventListener('click', () => {
        pictureBtn.setAttribute('hidden', true);
        let previewCanvas = document.createElement('canvas');
        previewCanvas.id = 'camera_preview_img';
        previewCanvas.height = videoElem.height;
        previewCanvas.width = videoElem.width;
        previewCanvas.setAttribute('date-timestamp', new Date().getTime());

        // Create the preview image
        let previewContext = previewCanvas.getContext('2d');
        previewContext.drawImage(videoElem, 0, 0, videoElem.width, videoElem.height);

        // Capture the actual high-def image
        let imageCanvas = document.createElement('canvas');
        imageCanvas.height = imageSource.height;
        imageCanvas.width = imageSource.width;
        imageCanvas.setAttribute('date-timestamp', new Date().getTime());

        let imageContext = imageCanvas.getContext('2d');
        imageContext.drawImage(imageSource, 0, 0, imageSource.width, imageSource.height);
      
        // Flash effect
        videoOverlay.style.backgroundColor = 'white';
        videoOverlay.style.transition = 'none';
        setTimeout(() => {
          videoOverlay.style.transition = '0.05s ease all';
          videoOverlay.style.backgroundColor = 'transparent';
          videoOverlay.appendChild(previewCanvas);
          toggleScene('preview', imageCanvas, editor);
        }, 200);
      });
      
      // Find all Camera devices and let the user choose
      populateCameraChoices();
    }
  });
}


module.exports = initWebcam;
exports.webcam = initWebcam;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Thu Jun 10 2021 06:31:01 GMT+0530 (India Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
