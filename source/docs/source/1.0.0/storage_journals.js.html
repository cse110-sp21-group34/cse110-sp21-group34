<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>storage/journals.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="initListeners.html">initListeners</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Journals.html">Journals</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#label">label</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#newlabel">newlabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#push">push</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#removelabel">removelabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Journals.html#save">save</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Label.html">Label</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="newEditor.html">newEditor</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html">NotSoSimpleAudio</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#_acceptTuneView">_acceptTuneView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#_make">_make</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#_toggleTune">_toggleTune</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#onDropHandler">onDropHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#onPaste">onPaste</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#render">render</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#renderSettings">renderSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleAudio.html#save">save</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="NotSoSimpleImage.html">NotSoSimpleImage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#_acceptTuneView">_acceptTuneView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#_make">_make</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#_toggleTune">_toggleTune</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#onDropHandler">onDropHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#onPaste">onPaste</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#render">render</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#renderSettings">renderSettings</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="NotSoSimpleImage.html#save">save</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="timer.html">timer</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createButton">createButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createLabel">createLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createNew">createNew</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createRecorder">createRecorder</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createTimerText">createTimerText</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#deleteTimerText">deleteTimerText</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#editLabel">editLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#initWebcam">initWebcam</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#populateCameraChoices">populateCameraChoices</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showWebcam">showWebcam</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toggleScene">toggleScene</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateDates">updateDates</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateMonthLanguage">updateMonthLanguage</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">storage/journals.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>class Journals {
  /**
   * Constructor
   * @param {Promise/function} source function or promise returning journal database
   * @param {function} submit callback for saving data
   */
  constructor(source, submit) {
    this.isReady = Promise.resolve(source).then(source => {
      return new Promise((resolve, reject) => {
        if (
          !source ||
          typeof source !== "object" ||
          Object.keys(source).length === 0
        ) {
          console.error(
            "[Journals] Source of journal is invalid. Received ",
            source,
            ". Using default"
          );
          source = {
            labels: {},
            journals: {},
            settings: {}
          };
        } else if (!"journals" in source || !"labels" in source) {
          console.error("[Journals] Invalid format. Using default");
          source = {
            labels: {},
            journals: {},
            settings: {}
          };
        }

        /*
          database = {
            "labels": {},
            "journals": {},
            "settings": {}
          }
        */
        this.database = { ...source };
        this.journals = this.database.journals;

        this.labels = new Object();
        /*
          labels_prop = {
              "label1": {
                  color: blue
              }
          }
        */
        let labels_prop = this.database.labels;

        this.submit = submit;

        // Initialize labels
        if (labels_prop) {
          for (const label in labels_prop) {
            this.labels[label] = new Label(label, labels_prop[label]);
          }
        } else {
          labels_prop = {};
        }

        for (const journal in this.journals) {
          const { label } = this.journals[journal];
          if (label) {
            if (!this.labels[label]) {
              let label_prop = labels_prop[label];
              if (!label_prop) label_prop = {}; // Default behavior when label prop is not set
              this.labels[label] = new Label(label, label_prop);
            }
            this.labels[label].link(journal, this.journals[journal]);
          }
        }

        resolve(this);
      });
    });
  }

  /**
   * Retrieve the journal object of a given date
   * @param {String} date
   * @return {object} journal object 
   */
  get(date) {
    if (!this.journals[date]) {
      console.log("[Journals] no such date");
      return {};
    }
    return this.journals[date];
  }

  /**
   * Store journal of the given date
   * @param {String} date date
   * @param {object} data journal object
   */
  save(date, data) {
    if (data) {
      if (!this.journals[date]) this.journals[date] = {};
      for (const key in data) {
        this.journals[date][key] = data[key];
      }
      return this.push().then(() => {
        console.log("[Journals] data saved")
      }).catch(error => {
        console.error(`[Journals] Error when saving journal on ${date}: ${error}`);
      });
    }
  }

  /**
   * Pushing data to backend asynchronously
   */
  push() {
    for (const label in this.labels) {
      this.database.labels[label] = this.labels[label].properties;
    }
    return this.submit(JSON.stringify(this.database));
    // console.log(this.database);
  }

  labelDate(date, label, args) {
    if (!this.journals[date]) {
      this.journals[date] = {labels: {}};
    }
    if (!this.journals[date].labels) {
      this.journals[date].labels = {};
    }
    this.journals[date].labels[label] = args;
    this.push();
  }

  removeLabelDate(date, label) {
    if (!this.journals[date] || 
        !this.journals[date].labels || 
        !this.journals[date].labels[label]) {
      return;
    }
    delete this.journals[date].labels[label];
    this.push();
  }

  getLabelDate(date) {
    if (!this.journals[date] || 
        !this.journals[date].labels) {
      return {};
    }
    return this.journals[date].labels;
  }


  /**
   * Create new label
   * @param {String} label label name
   * @param {Object} properties properties of the label
   * @returns {String} label name
   */
  newlabel(label, properties = {}) {
    if (this.labels[label]) {
      console.warn("[Journals] Attempting to create duplicated label: ", label);
    }
    this.labels[label] = new Label(label, properties);
    this.push();
    return label;
  }

  /**
   * Remove label
   * @param {String} label label name
   * @returns {int} return code
   */
  removelabel(label) {
    if (!this.labels[label]) return;
    if (Object.keys(this.labels[label].journals).length === 0) {
      // No journal is assicoated with this label, proceed to removal
      delete this.labels[label];
      this.push();
      return 0;
    }

    console.error(
      "[Journals] Failed to remove label: ",
      this.labels[label].name,
      " is used in ",
      Object.keys(this.labels[label].journals).join(" ")
    );
    return 1;
  }

  /**
   * Label a journal
   * @param {String} date date
   * @param {String} label label = null to remove label from a journal
   */
  label(date, label = null) {
    if (label &amp;&amp; !this.labels[label]) {
      console.error("[Journals] Label does not exist: ", label);
      return;
    }
    if (label === null || this.journals[date].label) {
      // Remove it first
      const old_label = this.journals[date].label;
      if (this.labels[old_label]) this.labels[old_label].detach(date);
    }
    if (label) this.labels[label].link(date, this.journals[date]);
    this.push();
    return 0;
  }

  /**
   * Getter for editor settings
   * @return {Object} settings
   */
  get settings() {
    if (this.database.settings == undefined) {
      this.database.settings = {};
    }
    return this.database.settings;
  }

  /**
   * Setter for editor settings
   * @param {Object} newSettings settings object
   */
  set settings(newSettings) {
    this.database.settings = Object.assign(this.database.settings, newSettings);
    this.push();
  }
}

class Label {
  /**
   * Lookup journals for reverse lookup (label -> dates)
   * Read-only. Do NOT modify directly. Maintained by Journal interface
   * @param {String} name 
   * @param {Object} properties 
   */
  constructor(name, properties) {
    this.name = name;
    this.properties = { ...properties };
    this.journals = {};
  }

  link(date, obj = null) {
    this.journals[date] = obj;
    return date;
  }

  detach(date) {
    const temp = this.journals[date];
    delete this.journals[date];
    return temp;
  }
}

module.exports = Journals;
exports.Journals = Journals;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Thu Jun 10 2021 06:31:01 GMT+0530 (India Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
